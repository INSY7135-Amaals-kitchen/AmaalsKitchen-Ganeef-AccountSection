@model AmaalsKitchen.Models.EditProfileViewModel
@{
    ViewData["Title"] = "Edit Profile";
}

<div class="container my-5">
    <h2 class="mb-4 text-center">Edit Profile</h2>

    <div class="card p-4 shadow-sm rounded-3" style="max-width:600px; margin:auto; background-color:var(--amaals-light-cream);">
        <form id="editProfileForm">
            @Html.AntiForgeryToken()
            <input asp-for="Email" type="hidden" />

            <div class="mb-3">
                <label asp-for="FirstName" class="form-label fw-bold" style="color:var(--amaals-red)"></label>
                <input asp-for="FirstName" class="form-control" />
                <span asp-validation-for="FirstName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="LastName" class="form-label fw-bold" style="color:var(--amaals-red)"></label>
                <input asp-for="LastName" class="form-control" />
                <span asp-validation-for="LastName" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="PhoneNumber" class="form-label fw-bold" style="color:var(--amaals-red)"></label>
                <input asp-for="PhoneNumber" class="form-control" />
                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Profile" class="btn btn-secondary me-2">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
                <button type="button" id="saveBtn" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Save
                </button>
            </div>
        </form>

        <div id="ajaxMessage" class="mt-3"></div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")

    <script>
        document.getElementById('saveBtn').addEventListener('click', async function () {
            var form = document.getElementById('editProfileForm');
            var data = {
                Email: form.querySelector('input[name="Email"]').value,
                FirstName: form.querySelector('input[name="FirstName"]').value,
                LastName: form.querySelector('input[name="LastName"]').value,
                PhoneNumber: form.querySelector('input[name="PhoneNumber"]').value
            };

            var token = form.querySelector('input[name="__RequestVerificationToken"]').value;

            try {
                var res = await fetch('@Url.Action("EditProfileAjax", "Account")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(data)
                });

                var result = await res.json();

                var msgDiv = document.getElementById('ajaxMessage');
                msgDiv.innerHTML = '';
                if (result.success) {
                    msgDiv.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                                            <i class="fas fa-check-circle me-2"></i>${result.message}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>`;

                    // Update profile page dynamically
                    if (window.location.href.includes("/Profile")) {
                        if (document.getElementById('profileFirstName')) document.getElementById('profileFirstName').innerText = result.firstName;
                        if (document.getElementById('profileLastName')) document.getElementById('profileLastName').innerText = result.lastName;
                        if (document.getElementById('profilePhoneNumber')) document.getElementById('profilePhoneNumber').innerText = result.phoneNumber;
                    } else {
                        // Redirect automatically to profile page after save
                        window.location.href = '@Url.Action("Profile", "Account")';
                    }

                    // Update navbar username immediately
                    if (document.getElementById('navUserName')) document.getElementById('navUserName').innerText = result.firstName;
                } else {
                    msgDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>${result.message}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>`;
                }
            } catch (e) {
                console.error(e);
            }
        });
    </script>
}
